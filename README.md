Документация проекта ChatGPT Interface
Этот документ описывает структуру, логику и основные компоненты веб-проекта, предназначенного для взаимодействия с API ChatGPT через собственный интерфейс с административной панелью для управления настройками и мониторингом.

Назначение проекта:

Проект предоставляет пользовательский веб-интерфейс для чата с моделью ChatGPT и административную панель для:

Настройки API ключа OpenAI.
Управления настройками отправки Email (SMTP).
Проведения тестирования подключения к API и отправки Email.
Управления прокси-сервером для запросов к API.
Настройки лимитов использования (токенов) для пользователей.
Настройки времени хранения чатов.
Управления доступными моделями OpenAI.
Смены пароля администратора.
Просмотра диагностической информации.
Просмотра логов ошибок.
Просмотра сводных отчетов (Дашборд).
Проект включает как пользовательскую часть (предполагается, но код пользовательского интерфейса чата не предоставлен полностью), так и защищенную административную панель.

Основные концепции и логика:

Авторизация Администратора: Доступ к административной панели защищен паролем, который хранится в базе данных. Авторизация осуществляется через файл login.php и управляется с помощью сессий PHP ($_SESSION["admin"]).
Управление Настройками: Различные настройки проекта (API ключ, SMTP, прокси, лимиты и т.д.) хранятся в одной строке таблицы settings в базе данных. Управление осуществляется через формы в админ-панели (settings.php, email_settings.php, proxy.php, limits.php, chat_ttl.php, models.php) и обрабатывается централизованным скриптом сохранения save.php. Некоторые настройки (API ключ, пароль прокси, пароль SMTP) хранятся в базе данных в зашифрованном виде.
Шифрование Данных: Для защиты чувствительных настроек (API ключ, пароли) используется симметричное шифрование (openssl_encrypt/openssl_decrypt) с ключами SECRET_KEY и SECRET_IV, которые должны быть определены в файле config.php.
Взаимодействие с API OpenAI: Проект отправляет запросы к API OpenAI, используя настроенный API ключ. Возможно использование прокси-сервера для этих запросов.
Отправка Email: Для отправки писем (например, тестовых или для сброса пароля) используется библиотека PHPMailer с настройками SMTP, хранящимися в базе данных. PHPMailer, судя по предоставленным путям, установлен вручную в папку libs или через Composer в vendor.
Логирование: Ошибки и важные события записываются в базу данных в таблицу error_logs с помощью функции логирования (вероятно, в файле log.php). Эти логи доступны для просмотра через админ-панель.
Дашборд: Сводная страница в админ-панели для отображения основных статистических показателей, полученных из базы данных (пользователи, чаты, сообщения, токены, ошибки).
AJAX Запросы: В админ-панели активно используются AJAX запросы (с помощью Fetch API) для асинхронного сохранения настроек и выполнения тестов (API, Email) без перезагрузки страницы.
Структура Админ-панели: Админ-панель организована как одностраничное приложение (index.php), которое загружает содержимое нужной страницы (.php файла) в зависимости от параметра page в URL. Меню в левой части (sidebar.php) обеспечивает навигацию.
Структура Базы Данных (предполагаемая на основе кода):

Проект использует реляционную базу данных (вероятно, MySQL, исходя из SQL синтаксиса). Ключевые таблицы:

users: Хранит информацию о пользователях (ID, имя, пароль, дата регистрации и т.д.). Используется для авторизации и, возможно, для привязки чатов и токенов.
chats: Хранит информацию о чат-сессиях (ID, пользователь, дата создания и т.д.).
messages: Хранит сообщения в чатах (ID, ID чата, отправитель (пользователь/AI), текст сообщения, дата создания).
token_usage: Хранит записи об использовании токенов (ID, пользователь/чат, количество токенов, дата/время). Используется для статистики и лимитов.
error_logs: Хранит записи логов ошибок (ID, уровень, сообщение, файл, строка, дата/время).
settings: Хранит общие настройки проекта в одной строке (API ключ, настройки SMTP, прокси, лимиты, время хранения чатов, включенные модели, часовой пояс и т.д.).
Описание Файлов Проекта:

.
├── admin/
│   ├── admin.php
│   ├── change_password.php
│   ├── dashboard.php
│   ├── diagnostics.php
│   ├── favicon.ico
│   ├── get_current_proxy.php
│   ├── get_enabled_models.php
│   ├── index.php
│   ├── load_logs.php
│   ├── load_openai_models.php
│   ├── login.php
│   ├── logout.php
│   ├── logs.php
│   ├── models.php
│   ├── proxy.php
│   ├── proxy_debug.txt
│   ├── reset_password.php
│   ├── save.php
│   ├── save_models.php
│   ├── settings.php
│   ├── sidebar.php
│   ├── test_api.php
│   ├── send_test_email_ajax.php  <-- Новый файл для AJAX теста Email
│   └── email_settings.php       <-- Новый файл для настроек Email
├── api/
│   ├── auth.php               (Предполагается, логика аутентификации пользователей)
│   ├── chats.php              (Предполагается, логика работы с чатами)
│   ├── config.php
│   ├── db.php
│   ├── log.php                (Предполагается, функция логирования)
│   ├── messages.php           (Предполагается, логика работы с сообщениями)
│   ├── openai_chat.php        (Предполагается, взаимодействие с API OpenAI)
│   ├── prune_chats.php
│   ├── token_usage.php        (Предполагается, логика работы с токенами)
│   └── users.php              (Предполагается, логика работы с пользователями)
├── libs/                     (Предполагается, если PHPMailer установлен вручную)
│   └── PHPMailer/
│       └── src/
│           ├── PHPMailer.php
│           ├── SMTP.php
│           └── Exception.php
├── vendor/                   (Альтернативное расположение для PHPMailer при установке через Composer)
│   └── autoload.php
└── version.php
(Примечание: Файлы в api/ и libs/, а также корневой version.php, proxy_debug.txt, favicon.ico и некоторые скрипты в admin/ описаны на основе названий и общих практик, так как их полный код не был предоставлен, за исключением mail_settings.php и test_mail.php (старые версии, использованные для адаптации) и фрагментов из 2.1.0.txt).

Детальное описание ключевых файлов (включая изменения):

/version.php:

Назначение: Хранит текущую версию проекта.
Логика: Вероятно, определяет константу с номером версии.
Использование: Включается в admin/index.php для вывода версии в админ-панели.
/api/config.php:

Назначение: Хранит конфигурационные константы, включая ключи для шифрования.
Логика: Определяет SECRET_KEY и SECRET_IV.
Использование: Подключается в файлах, где происходит шифрование/дешифрование настроек (admin/save.php, admin/settings.php, admin/email_settings.php, admin/proxy.php, admin/send_test_email_ajax.php).
/api/db.php:

Назначение: Устанавливает соединение с базой данных.
Логика: Вероятно, содержит код для подключения к БД с использованием PDO.
Использование: Подключается практически во всех PHP файлах, которые взаимодействуют с базой данных (большинство файлов в admin/ и api/).
/api/log.php:

Назначение: Предоставляет функцию для записи логов ошибок и других событий в таблицу error_logs.
Логика: Вероятно, принимает уровень логирования, сообщение и, возможно, информацию о файле/строке, и вставляет запись в error_logs.
Использование: Предполагается, что используется в API файлах и в админ-панели при возникновении ошибок (например, в admin/send_test_email_ajax.php).
/admin/index.php:

Назначение: Точка входа в административную панель. Управляет загрузкой содержимого страниц и авторизацией.
Логика: Проверяет сессию администратора. Определяет, какую страницу запросил пользователь ($_GET['page']). Проверяет, разрешена ли запрошенная страница (массив $allowed). Если разрешена и файл существует, включает соответствующий .php файл.
Изменения: Массив $allowed и страница по умолчанию были изменены в процессе добавления/удаления страниц настроек (например, добавлены email_settings, dashboard, general_settings, затем удалены test_email, general_settings, добавлен timezone_settings, затем удален timezone_settings). В последней версии: $allowed = ["dashboard", "settings", "email_settings", "proxy", "admin", "diagnostics", "logs", "models", "limits", "chat_ttl"]; страница по умолчанию 'settings'.
Использование: Включает sidebar.php и содержимое текущей страницы.
/admin/sidebar.php:

Назначение: Отображает боковое меню навигации административной панели.
Логика: Содержит HTML структуру меню с ссылками на различные страницы админки (?page=...). Использует JavaScript (Bootstrap Collapse) для сворачиваемых/раскрываемых разделов меню ("Настройки"). PHP используется для определения текущей страницы ($current_page) и добавления активных классов (active bg-secondary) к соответствующим пунктам меню, а также для управления состоянием сворачиваемых разделов (aria-expanded, show класс).
Изменения: Структура меню претерпела значительные изменения, включая создание и последующее удаление подраздела "Общие", а также добавление и последующее удаление пункта "Часовой пояс". В текущей версии: Главный раздел "Настройки" сворачивается, внутри него прямые ссылки на "Настройки API", "Настройки Email", "Лимиты", "Время хранения чатов", "Модели", "Прокси", "Сменить пароль админа". Пункты "Дашборд", "Диагностика", "Логи", "Выйти" - отдельные.
/admin/settings.php:

Назначение: Отображает форму для настройки API ключа OpenAI.
Логика: Загружает текущий API ключ из таблицы settings (дешифрует его). Отображает HTML форму с полем ввода для ключа и кнопками "Сохранить" и "Проверить API". Содержит JavaScript для AJAX сохранения формы и для AJAX вызова скрипта test_api.php при нажатии кнопки "Проверить API", включая индикацию процесса тестирования.
Изменения: Изначально мог содержать другие настройки. Был изменен, чтобы включать только настройки API ключа, а затем временно объединен с настройками часового пояса в general_settings.php, но потом восстановлен как отдельная страница только для API. Добавлен AJAX скрипт с индикацией для кнопки "Проверить API".
Использование: Включается в index.php при ?page=settings. Отправляет данные на save.php. Вызывает get_current_proxy.php и test_api.php через AJAX.
/admin/email_settings.php:

Назначение: Отображает форму для настройки параметров отправки Email (SMTP).
Логика: Загружает текущие настройки SMTP (хост, порт, аутентификация, логин, пароль - зашифрованный, шифрование, тестовый получатель) из таблицы settings. Отображает HTML форму с полями для этих настроек и кнопками "Сохранить настройки почты" и "Тестировать отправку". Пароль для безопасности не выводится в форму. Содержит JavaScript для AJAX сохранения формы на save.php и для AJAX вызова send_test_email_ajax.php при нажатии кнопки "Тестировать отправку", включая индикацию процесса. Использует функцию decrypt.
Изменения: Этот файл был создан на основе логики из старого mail_settings.php и наших требований (использование smtp_ полей, интеграция AJAX тестирования).
Использование: Включается в index.php при ?page=email_settings. Отправляет данные на save.php. Вызывает send_test_email_ajax.php через AJAX.
/admin/save.php:

Назначение: Обрабатывает AJAX запросы на сохранение настроек из различных форм админ-панели.
Логика: Проверяет авторизацию администратора. Получает данные из $_POST. Перебирает ожидаемые имена полей настроек (API ключ, лимиты, TTL чатов, прокси, настройки SMTP, тестовый получатель). Если поле найдено в $_POST, добавляет его к списку полей для обновления в базе данных. Шифрует чувствительные данные (api_key, proxy, smtp_password) перед добавлением в параметры запроса. Формирует и выполняет SQL запрос UPDATE к таблице settings. Возвращает JSON ответ с результатом сохранения (success или error).
Изменения: Расширен для обработки всех добавленных полей настроек (лимиты, TTL, прокси, SMTP, тестовый получатель, часовой пояс - который потом был удален). Логика шифрования адаптирована для новых полей.
Использование: Является целью action для форм сохранения в settings.php, email_settings.php, proxy.php, limits.php, chat_ttl.php, models.php, admin.php, timezone_settings.php (удален).
/admin/test_api.php:

Назначение: Выполняет проверку работоспособности API ключа OpenAI, используя указанный ключ и, опционально, прокси.
Логика: Принимает api_key, proxy, proxy_type через POST (JSON). Настраивает CURL для выполнения запроса к API OpenAI, применяет настройки прокси, если они предоставлены. Отправляет простой запрос к API (например, запрос списка моделей). Анализирует ответ и возвращает HTML строку с результатом проверки (Успех/Ошибка).
Использование: Вызывается через AJAX из settings.php при нажатии "Проверить API".
/admin/send_test_email_ajax.php:

Назначение: Обрабатывает AJAX запрос на отправку тестового письма SMTP.
Логика: Проверяет авторизацию администратора. Получает настройки SMTP (хост, порт, аутентификация, логин, пароль - из POST или БД, шифрование, тестовый получатель) из POST данных (FormData), отправленных формой из email_settings.php. Использует библиотеку PHPMailer для подключения к SMTP серверу и отправки тестового письма. Пароль для теста берется либо из POST (если введен в форме), либо дешифруется из БД (если поле в форме пустое, но аутентификация включена). Возвращает JSON ответ с результатом отправки (success или error) и деталями ошибки PHPMailer при неудаче. Подключает PHPMailer, вероятно, из папки libs.
Изменения: Этот файл был создан на основе логики из старого test_mail.php, адаптирован для приема данных из FormData и использования smtp_ полей. Исправлен путь подключения PHPMailer, добавлена логика получения пароля из POST или БД.
Использование: Вызывается через AJAX из email_settings.php при нажатии "Тестировать отправку".
/admin/dashboard.php:

Назначение: Отображает сводную информацию и отчеты по использованию проекта.
Логика: Подключается к БД. Выполняет SQL запросы для подсчета общего количества пользователей, чатов, сообщений, использованных токенов. Считает пользователей и токены за текущий день. Выбирает последние записи логов ошибок. Отображает полученные метрики в HTML структуре с использованием карточек Bootstrap.
Изменения: Добавлен PHP код для получения данных из БД и их вывода. Изначально включал логику отображения времени логов с учетом часового пояса пользователя, но затем эта логика была удалена.
Использование: Включается в index.php при ?page=dashboard.
/admin/logs.php:

Назначение: Страница для просмотра логов ошибок.
Логика: Вероятно, предоставляет структуру страницы (HTML) и JavaScript для загрузки записей логов с помощью AJAX запроса к load_logs.php, возможно с фильтрами или пагинацией.
Изменения: Изначально мог загружать все логи напрямую или использовать другую механику. Был адаптирован для работы с load_logs.php. Логика отображения времени изначально могла включать конвертацию часового пояса, но затем была удалена.
Использование: Включается в index.php при ?page=logs. Использует AJAX для вызова load_logs.php.
/admin/load_logs.php:

Назначение: Загружает записи логов ошибок из базы данных и возвращает их (вероятно, в HTML или JSON формате) для отображения на странице logs.php.
Логика: Подключается к БД. Выполняет SQL запрос для выборки логов из таблицы error_logs, возможно с учетом параметров фильтрации или пагинации из GET/POST запроса. Форматирует каждую запись лога. Возвращает отформатированный список логов.
Изменения: Логика получения записей логов и их форматирования. Изначально включал логику загрузки настройки часового пояса и конвертации времени, но затем эта логика была удалена, и время выводится "как есть" из БД.
Использование: Вызывается через AJAX из logs.php.
/admin/login.php:

Назначение: Предоставляет форму авторизации администратора.
Логика: Отображает HTML форму для ввода логина и пароля (или только пароля, если логин фиксирован). Обрабатывает POST запрос: проверяет введенный пароль с хешем пароля администратора, хранящимся в базе данных (таблица users, возможно поле admin_password_hash в таблице settings). При успешной авторизации устанавливает сессионную переменную ($_SESSION["admin"] = true;) и перенаправляет на index.php.
Использование: Точка входа для администраторов.
/admin/logout.php:

Назначение: Завершает сессию администратора.
Логика: Уничтожает сессию PHP и перенаправляет на страницу логина.
Использование: Вызывается по ссылке "Выйти" в меню.
/admin/change_password.php:

Назначение: Страница для смены пароля администратора.
Логика: Отображает форму для ввода старого и нового пароля. Обрабатывает POST запрос: проверяет старый пароль, хеширует новый пароль и сохраняет его в базе данных.
Использование: Включается в index.php при ?page=admin.
/admin/proxy.php:

Назначение: Страница для настройки прокси-сервера.
Логика: Загружает текущие настройки прокси из таблицы settings (дешифрует адрес). Отображает форму для ввода адреса прокси, типа прокси (HTTP, SOCKS5 и т.д.) и, возможно, учетных данных. Содержит JavaScript для AJAX сохранения формы на save.php и, вероятно, для тестирования прокси (test_proxy.php).
Использование: Включается в index.php при ?page=proxy.
/admin/test_proxy.php:

Назначение: Выполняет проверку работоспособности настроенного прокси-сервера.
Логика: Принимает настройки прокси через POST. Пытается выполнить тестовый запрос (например, к публичному API или простому HTTP ресурсу) через указанный прокси с использованием CURL. Возвращает результат теста (Успех/Ошибка).
Использование: Вероятно, вызывается через AJAX из proxy.php.
/admin/models.php:

Назначение: Страница для управления доступными моделями OpenAI.
Логика: Загружает список моделей из таблицы settings (или другого источника, возможно, из API OpenAI при первом запуске). Отображает список моделей, возможно с возможностью включения/отключения или установки настроек для каждой модели. Содержит JavaScript для AJAX сохранения изменений (save_models.php) и, возможно, для загрузки актуального списка моделей с API OpenAI (load_openai_models.php).
Использование: Включается в index.php при ?page=models.
/admin/save_models.php:

Назначение: Обрабатывает AJAX запрос на сохранение настроек моделей.
Логика: Получает данные о моделях из POST. Сохраняет их в базу данных (вероятно, в поле enabled_models таблицы settings в формате JSON).
Использование: Вероятно, вызывается через AJAX из models.php.
/admin/load_openai_models.php:

Назначение: Загружает актуальный список моделей из API OpenAI.
Логика: Использует API ключ (из settings) и, возможно, прокси (из settings) для запроса к API OpenAI за списком доступных моделей. Возвращает полученный список.
Использование: Вероятно, вызывается через AJAX из models.php.
/admin/limits.php:

Назначение: Страница для настройки лимитов использования (токенов).
Логика: Загружает текущие лимиты (минута, час, день, неделя, месяц) из таблицы settings. Отображает форму для ввода лимитов. Содержит JavaScript для AJAX сохранения формы на save.php.
Использование: Включается в index.php при ?page=limits.
/admin/chat_ttl.php:

Назначение: Страница для настройки времени хранения чатов (Time To Live).
Логика: Загружает текущую настройку времени хранения (в днях) из таблицы settings. Отображает форму для ввода значения. Содержит JavaScript для AJAX сохранения формы на save.php.
Использование: Включается в index.php при ?page=chat_ttl.
/admin/diagnostics.php:

Назначение: Страница для проведения диагностики системы.
Логика: Может проверять соединение с базой данных, наличие необходимых расширений PHP, доступность внешних ресурсов (например, API OpenAI, если нет отдельной кнопки теста), права доступа к файлам/папкам. Выводит результаты проверок.
Использование: Включается в index.php при ?page=diagnostics.
/admin/get_current_proxy.php:

Назначение: Предоставляет текущие настройки прокси в формате JSON.
Логика: Загружает настройки прокси из таблицы settings, дешифрует адрес и возвращает JSON объект с proxy и proxy_type.
Использование: Вызывается через AJAX из settings.php (для теста API) и, вероятно, из proxy.php (для теста прокси).
/admin/reset_password.php:

Назначение: Скрипт для сброса пароля пользователя (вероятно, пользовательской части).
Логика: Может генерировать токен сброса, сохранять его в БД, отправлять письмо пользователю со ссылкой на сброс пароля (используя настройки SMTP). Часть логики отправки письма из старого test_mail.php была, вероятно, изначально отсюда.
Использование: Часть функционала пользовательской части или админ-панели для управления пользователями.
/admin/proxy_debug.txt:

Назначение: Файл для отладочной информации по прокси.
Логика: Предполагается, что скрипты тестирования прокси (test_proxy.php) или взаимодействия с API через прокси могут записывать сюда отладочные данные.
/libs/PHPMailer/ или /vendor/:

Назначение: Директория с библиотекой PHPMailer.
Логика: Содержит PHP классы для работы с Email (PHPMailer, SMTP, Exception).
Использование: Классы из этой папки подключаются (require) в скриптах, которые отправляют Email (send_test_email_ajax.php, reset_password.php).
Связь между файлами и логика:

index.php -> включает sidebar.php и загружает контент страницы (.php файл)
Страницы настроек (settings.php, email_settings.php, limits.php, ...) -> включают db.php и config.php, загружают настройки из settings, отображают формы, используют AJAX для отправки форм на save.php. Некоторые страницы настроек используют AJAX для тестов (test_api.php, send_test_email_ajax.php, test_proxy.php).
save.php -> включает db.php и config.php, обрабатывает POST данные из форм настроек, шифрует, сохраняет в settings.
send_test_email_ajax.php -> включает db.php (для получения пароля), config.php, log.php, PHPMailer. Принимает данные POST, отправляет тестовое письмо, логирует, возвращает JSON.
test_api.php -> включает config.php, использует CURL, опционально get_current_proxy.php. Тестирует API.
dashboard.php, logs.php, load_logs.php -> включают db.php, запрашивают данные из логов и других таблиц БД, отображают их. load_logs.php вызывается AJAX из logs.php.
Зависимости:

PHP (с расширениями PDO, openssl, curl, mbstring).
База данных (MySQL или совместимая).
Веб-сервер (Apache, Nginx).
PHPMailer (установлен в libs/ или через Composer в vendor/).
